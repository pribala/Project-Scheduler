<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Foundation Starter Template</title>
    <!-- Compressed CSS -->
    <!-- <link rel="stylesheet" href="https://dhbhdrzi4tiry.cloudfront.net/cdn/sites/foundation.min.css"> -->
    <!-- Compressed CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.4.3/css/foundation.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/motion-ui/1.2.2/motion-ui.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <link href="https://fonts.googleapis.com/css?family=Cinzel+Decorative:900" rel="stylesheet">
    <!-- Compressed JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.4.3/js/foundation.min.js"></script>
  </head>
  <body>

    <!-- event input form -->
    <button id="authorize-button" class="button" >Sign In</button>
    <button id="signout-button" class="button" >Sign Out</button>
    <div class="grid-container">
        <div class="grid-x grid-margin-x">
        <div class="medium-8" cell>
          <div class="card">
                  <div class="card-divider">
                      Requested Events
                  </div>
                  <div class="card-section">
                    <table>
                      <thead>
                        <tr>
                          <th>Event Summary</th>
                          <th>Location</th>
                          <th>Start Time</th>
                          <th>End Time</th>
                          <th>Requested by</th>
                          <th>Attendees</th>
                        </tr>
                      </thead>
                      <tbody id="pendingEvents">
                      </tbody>
                    </table>
                  </div>
                </div>	
        </div>
  
            <div class="medium-4 cell">
                <div class="card">
                  <div class="card-divider">
                      Add Event
                  </div>
                  <div class="card-section">
                      <form id="inputForm">
                        <label>Event Summary
                            <input type="text" id="summary" placeholder="Enter event summary">
                        </label>
                         <label>Location
                            <input type="text" id="location" placeholder="Enter event location">
                        </label>
                        <label>Start Time
                            <input type="text" id="startTime" placeholder="Enter event start time">
                        </label>
                        <label>End Time
                            <input type="text" id="endTime" placeholder="Enter event end time">
                        </label>
                        <label>Attendees
                            <textarea id="attendees" placeholder="Enter attendee emails"></textarea>
                        </label>
                          <input type="submit" class="button" value="Submit" id="addEvent">
                      </form> 
                  </div>
                </div>
            </div>
        </div>    
          <div class="grid-x">
            <div class="medium-12 small-12 cell">
          <table>
            <thead>
                <tr>
                  <th>Event Summary</th>
                  <th>When</th>
                </tr>
              </thead>
               <tbody id="event-data">
               </tbody>
            </table>
        </div>
      </div>
    </div>    
  <table >
    <tbody id="content"></tbody>
  </table>
  
 
    <script src="https://www.gstatic.com/firebasejs/4.3.1/firebase.js"></script>
    <script src="assets/javascript/calender.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.js"></script>
    <script>
      var config = {
        apiKey: "AIzaSyDmKpVmVd3N_dA4wAKrxX6L-pqxDvDXNAk",
        authDomain: "scheduler-708c6.firebaseapp.com",
        databaseURL: "https://scheduler-708c6.firebaseio.com",
        projectId: "scheduler-708c6",
        storageBucket: "",
        messagingSenderId: "545118572679"
      };
      firebase.initializeApp(config);
         // Create a variable to reference the database.
   database = firebase.database();
      var CLIENT_ID = '545118572679-qn8k1nb5d0udfc107r5rbevakgf8l6lb.apps.googleusercontent.com';

      // Array of API discovery doc URLs for APIs used by the quickstart
      var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      var SCOPES = 'https://www.googleapis.com/auth/calendar';
      //var SCOPES = "https://www.googleapis.com/auth/calendar.readonly"
      var authorizeButton = document.getElementById('authorize-button');
      var signoutButton = document.getElementById('signout-button');

      /**
       *  On load, called to load the auth2 library and API client library.
       */
      function handleClientLoad() {
        gapi.load('client:auth2', initClient);
      }

      /**
       *  Initializes the API client library and sets up sign-in state
       *  listeners.
       */
      function initClient() {
        gapi.client.init({
          discoveryDocs: DISCOVERY_DOCS,
          clientId: CLIENT_ID,
          scope: SCOPES
        }).then(function () {
          // Listen for sign-in state changes.
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

          // Handle the initial sign-in state.
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
          authorizeButton.onclick = handleAuthClick;
          signoutButton.onclick = handleSignoutClick;
        });
      }

      /**
       *  Called when the signed in status changes, to update the UI
       *  appropriately. After a sign-in, the API is called.
       */
      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
          authorizeButton.style.display = 'none';
          signoutButton.style.display = 'block';
          //addUpcomingEvent();
          listUpcomingEvents();
        } else {
          authorizeButton.style.display = 'block';
          signoutButton.style.display = 'none';
        }
      }

      /**
       *  Sign in the user upon button click.
       */
      function handleAuthClick(event) {
        gapi.auth2.getAuthInstance().signIn();
      }

      /**
       *  Sign out the user upon button click.
       */
      function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
      }

      /**
       * Append a pre element to the body containing the given message
       * as its text node. Used to display the results of the API call.
       *
       * @param {string} message Text to be placed in pre element.
       */
      function appendPre(message) {
        var pre = document.getElementById('content');
        var textContent = document.createTextNode(message + '\n');
        pre.appendChild(textContent);
      }
      function splitStr(str) {
        var strArray = str.split(",");
        var emails = [];
        strArray.forEach(function(item) {
          emails.push(
            {"'emails'": item});
          // create an array of attendees object- email: 'value'
        });
          console.log(emails);
          return emails;
      }
      
      /**
       * Print the summary and start datetime/date of the next ten events in
       * the authorized user's calendar. If no events are found an
       * appropriate message is printed.
       */
       $("#addEvent").on("click", function(e) {
        e.preventDefault();
        console.log("hi");
        var summary = $("#summary").val().trim();
        var location = $("#location").val().trim();
        var startTime = new Date($("#startTime").val().trim());
        var endTime = new Date($("#endTime").val().trim());
        //datetimes must be in this format YYYY-MM-DDTHH:MM:SS.MMM+HH:MM
        ////So that's year, month, day, the letter T, hours, minutes, seconds, miliseconds, + or -, timezoneoffset in hours and minutes
        var attendees = $("#attendees").val().trim();
        var invitees = splitStr(attendees);
        console.log(invitees);
        var currentUser = "priya.balakrishnan@gmail.com";
         //Add event to the pending requests list and database
  database.ref('pending-events/').push({
          summary: summary,
          location: location,
          startTime: startTime,
          endTime: endTime,
          attendees: attendees,
          currentUser: currentUser,
        });
        $("#summary").text("");
        $("#location").text("");
        $("#startTime").val("");
        $("#endTime").val("");
        $("#attendees").val("");
        
  var row = $("<tr>");
  var col1 = $("<td>");
  col1.text(summary);
  var col2 = $("<td>");
  col2.text(location);
  var col3 = $("<td>");
  col3.text(startTime);
  var col4 = $("<td>");
  col4.text(endTime);
  var col5 = $("<td>");
  col5.text("pb");
  var col6 = $("<td>");
  col6.text(attendees);
  //if logged in user same as calendar owner allow to add events to cal and delete it from firebase
  // delete, edit button deletes,edits from firebase
  var dataButtons = $("<td>");
  var btn = $("<span>");
  btn.attr("id", "delete");
  btn.html("<i class='fa fa-trash' aria-hidden='true'>");
  btn.addClass("btnClass");
  var editBtn = $("<span>");
  editBtn.attr("id", "edit");
  editBtn.html("<i class='fa fa-pencil' aria-hidden='true'></i>");
  editBtn.addClass("btnClass");
  var addBtn = $("<span>");
  addBtn.attr("id", "addToCal");
  addBtn.html('<i class="fa fa-check" aria-hidden="true"></i>');
  addBtn.addClass("btnClass");
  dataButtons.append(addBtn).append(btn).append(editBtn);
  row.append(col1).append(col2).append(col3).append(col4).append(col5).append(col6).append(dataButtons);
  $("#pendingEvents").append(row);
        var event = {
          'summary': summary,
          'location': location,
          'start': {
            'dateTime': startTime.toISOString(),
            'timeZone': 'America/New_York'
          },
          'end': {
            'dateTime': endTime.toISOString(),
            'timeZone': 'America/New_York'
          },
          'attendees': [invitees],
          'reminders': {
            'useDefault': false,
            'overrides': [
              {'method': 'email', 'minutes': 24 * 60},
              {'method': 'popup', 'minutes': 10}
            ]
          }
        };
        console.log(summary);
        console.log(event);
        addUpcomingEvent(event);
       });
       function splitStr(str) {
  var strArray = str.split(",");
  var emails = [];
  strArray.forEach(function(item) {
    // create an array of attendees object- email: 'value'
    emails.push(
      {"'emails'": item});
  });
    console.log(emails);
    return emails;
}
       function listUpcomingEvents() {
        gapi.client.calendar.events.list({
          'calendarId': 'primary',
          'timeMin': (new Date()).toISOString(),
          'showDeleted': false,
          'singleEvents': true,
          'maxResults': 10,
          'orderBy': 'startTime'
        }).then(function(response) {
          var events = response.result.items;
          appendPre('Upcoming events:');

          if (events.length > 0) {
            for (i = 0; i < events.length; i++) {
              var event = events[i];
              var when = event.start.dateTime;
              if (!when) {
                when = event.start.date;
              }
              // appendPre(event.summary + ' (' + when + ')')
              var row = $("<tr>");
        var td1 = $("<td>");
        td1.text(event.summary);
        var td2 = $("<td>");
        td2.text(when);
        row.append(td1).append(td2);
        $("#event-data").append(row);
            }
          } else {
            appendPre('No upcoming events found.');
          }
        });
      }

      function addUpcomingEvent(event) {
        console.log(event);
        
        var request = gapi.client.calendar.events.insert({
  'calendarId': 'primary',
  'resource': event,
  'sendNotifications': true
});

request.execute(function(event) {
  console.log('Event created: ' + event.htmlLink);
});

}
</script>
    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
    <script>
      var url = window.location.search;
        var queryString = url ? url.split('?')[1] : window.location.search.slice(1);
        console.log(queryString);
        //queryString = "priya.balakrishnan@gmail.com";
        var path ="https://www.google.com/calendar/embed?src="+queryString+"&ctz=America/New_York";
        $("iframe").attr("src", path);
    </script>
  </body>
</html>